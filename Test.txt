-- 1) Create a temp “history” with one open row for A1
CREATE TEMP TABLE history AS
SELECT
  1                     AS AGREEMENT_IDENTIFIER,
  'A1'                  AS SOURCE_SYSTEM_AGREEMENT_NUMBER,
  '2025-01-01T00:00:00'  AS EFFECTIVE_FROM_DATE,
  '9999-12-31T23:59:59'  AS EFFECTIVE_TO_DATE,
  100                   AS ATTR_VALUE,
  FARM_FINGERPRINT(CONCAT('A1','|100')) AS ROW_HASH;

-- 2) Simulate your last-run was “now minus one day”
DECLARE last_run DATETIME DEFAULT DATETIME_SUB(CURRENT_DATETIME(), INTERVAL 1 DAY);

-- 3) Build a temp “source” with two SCD2 rows—one closing, one opening
CREATE TEMP TABLE src AS
SELECT * FROM UNNEST([
  STRUCT<'A1',DATETIME,DATETIME,INT64>('A1',
    DATETIME '2025-01-01 00:00:00',  DATETIME_SUB(CAST(CURRENT_DATETIME() AS DATETIME), INTERVAL 12 HOUR), 100),
  STRUCT<'A1',DATETIME,DATETIME,INT64>('A1',
    DATETIME_SUB(CAST(CURRENT_DATETIME() AS DATETIME), INTERVAL 12 HOUR), DATETIME '9999-12-31 23:59:59', 110)
]) AS t (SOURCE_SYSTEM_AGREEMENT_NUMBER, EFFECTIVE_FROM_DATE, EFFECTIVE_TO_DATE, ATTR_VALUE);

-- 4) Your feed extraction picks both segments
CREATE TEMP TABLE feed AS
SELECT
  *,
  FARM_FINGERPRINT(CONCAT(SOURCE_SYSTEM_AGREEMENT_NUMBER,'|',CAST(ATTR_VALUE AS STRING))) AS ROW_HASH
FROM src
WHERE
  DATETIME(EFFECTIVE_FROM_DATE) >= last_run
  OR (EFFECTIVE_TO_DATE <> DATETIME '9999-12-31 23:59:59'
      AND DATETIME(EFFECTIVE_TO_DATE) >= last_run);

-- 5) Current live from history
CREATE TEMP TABLE current_live AS
SELECT
  AGREEMENT_IDENTIFIER,
  ROW_HASH       AS existing_hash,
  EFFECTIVE_FROM_DATE AS existing_from,
  EFFECTIVE_TO_DATE   AS existing_to,
  ROW_NUMBER() OVER(ORDER BY EFFECTIVE_FROM_DATE DESC) AS rn
FROM history
WHERE EFFECTIVE_TO_DATE = DATETIME '9999-12-31 23:59:59';

-- 6) Plan: compare each feed row to the live row for A1
SELECT
  f.*,
  c.AGREEMENT_IDENTIFIER,
  c.existing_hash,
  CASE
    WHEN c.AGREEMENT_IDENTIFIER IS NULL THEN 'INSERT'
    WHEN c.existing_hash <> f.ROW_HASH THEN 'UPDATE'
    ELSE 'UNCHANGED'
  END AS ACTION
FROM feed f
LEFT JOIN current_live c
  ON f.SOURCE_SYSTEM_AGREEMENT_NUMBER = (SELECT SOURCE_SYSTEM_AGREEMENT_NUMBER FROM history)
 AND c.rn = 1;
